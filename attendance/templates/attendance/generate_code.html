<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Code</title>
    <style>
        #code-display {
            font-family: monospace;
            font-size: 1.2em;
            margin-top: 10px;
        }
        #countdown {
            font-weight: bold;
        }
        #generated-by {
            display: none; /* Initially hidden */
        }
    </style>
    <script>
        async function generateCode() {
            const button = document.getElementById("generate-button");
            const codeDisplay = document.getElementById("code-display");
            const countdownElement = document.getElementById("countdown");
            const generatedBy = document.getElementById("generated-by");

            button.disabled = true;
            codeDisplay.innerText = "Generating code...";
            countdownElement.innerText = ""; // Clear any previous countdown
            generatedBy.style.display = "none"; // Hide "generated by"


            try {
                const response = await fetch("{% url 'attendance:generate_code' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json",
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Server error");
                }

                const data = await response.json();
                codeDisplay.innerText = `Code: ${data.code}`;


                startCountdown(data.expiry_time, countdownElement);  // Pass countdownElement

                generatedBy.style.display = "block"; // Show "generated by"

            } catch (error) {
                codeDisplay.innerText = `Error: ${error.message}`;
            } finally {
                button.disabled = false;
            }
        }

        function startCountdown(expiryTime, countdownElement) {  // Accept countdownElement
             if (isNaN(expiryTime) || expiryTime <= 0) {
                 countdownElement.innerText = "Invalid expiry time received from server.";
                 return; // Stop if the expiry time is invalid.
             }
            const expiryDate = new Date(expiryTime * 1000);

            const interval = setInterval(() => {
                const now = new Date().getTime();
                const timeLeft = expiryDate - now;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    countdownElement.innerText = "Code expired!";
                } else {
                    const seconds = Math.floor(timeLeft / 1000);
                    countdownElement.innerText = `Code expires in: ${seconds} seconds`;
                }
            }, 1000);
        }
    </script>
</head>
<body>
    <h1>Generate Attendance Code</h1>
    <button id="generate-button" onclick="generateCode()">Generate Code</button>
    <p id="code-display"></p>
    <p id="countdown"></p>
    <p id="generated-by">Code generated by {{ user.username }}</p> </body>
    <!-- Example in generate_code.html -->
    <a href="{% if latest_code %}{% url 'attendance:attendance_list' latest_code %}{% else %}#{% endif %}">
        View Attendance
    </a>

</html>